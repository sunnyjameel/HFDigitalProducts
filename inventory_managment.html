<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .no-print {
            /* For print media queries if needed */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase functions globally accessible (for Babel script)
        window.firebaseApp = initializeApp;
        window.firebaseAuth = { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
        window.firebaseFirestore = { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where };
    </script>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        const ReactDOM = window.ReactDOM;

        // Context for Firebase and User
        const FirebaseContext = createContext(null);

        // Reusable Modal Component (for alerts, confirms, forms)
        const Modal = ({ isOpen, onClose, title, children, footer, isError = false }) => {
          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in">
              <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-auto transform scale-95 transition-transform duration-200 ease-out">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className={`text-2xl font-bold ${isError ? 'text-red-600' : 'text-gray-800'}`}>{title}</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 transition-colors">
                      <i className="fas fa-times text-xl"></i>
                    </button>
                  </div>
                  <div className="mb-6 text-gray-700">
                    {children}
                  </div>
                  {footer && (
                    <div className="flex justify-end space-x-3">
                      {footer}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // Reusable Loading Spinner
        const LoadingSpinner = () => (
          <div className="flex justify-center items-center py-8">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
            <p className="ml-3 text-gray-600">Loading...</p>
          </div>
        );

        // Define currency symbols
        const currencySymbols = {
          'USD': '$',
          'PKR': 'Rs.',
          'EUR': '€',
          'GBP': '£'
        };

        // Zustand-like simple store for global state
        let _state = {
          products: [],
          orders: [],
          userId: null,
          isAuthReady: false,
          loading: true,
          error: null,
          db: null,
          auth: null,
          selectedCurrency: 'PKR', // Default currency set to PKR
          modal: { isOpen: false, title: '', message: '', isError: false, onClose: () => {} },
          confirmModal: { isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} }
        };
        const _listeners = [];

        const useStore = () => {
          const [state, setState] = useState(_state);

          useEffect(() => {
            const listener = (newState) => setState({ ...newState });
            _listeners.push(listener);
            return () => {
              const index = _listeners.indexOf(listener);
              if (index > -1) _listeners.splice(index, 1);
            };
          }, []);

          const set = (updater) => {
            _state = { ..._state, ...(typeof updater === 'function' ? updater(_state) : updater) };
            _listeners.forEach(listener => listener(_state));
          };

          return [state, set];
        };

        // Main App Component
        function App() {
          const [state, set] = useStore();
          const [currentPage, setCurrentPage] = useState('dashboard'); // 'dashboard', 'products', 'orders'

          useEffect(() => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
              set({ error: 'Firebase configuration is missing or invalid. Please provide a valid Firebase config.', loading: false });
              return;
            }

            try {
              const app = window.firebaseApp(firebaseConfig);
              const auth = window.firebaseAuth.getAuth(app);
              const db = window.firebaseFirestore.getFirestore(app);

              set({ db, auth });

              const unsubscribe = window.firebaseAuth.onAuthStateChanged(auth, async (user) => {
                if (user) {
                  set({ userId: user.uid, isAuthReady: true });
                  console.log("Firebase Authenticated. User ID:", user.uid);
                } else {
                  try {
                    const anonUser = await window.firebaseAuth.signInAnonymously(auth);
                    set({ userId: anonUser.user.uid, isAuthReady: true });
                    console.log("Signed in anonymously. User ID:", anonUser.user.uid);
                  } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    set({ error: `Authentication failed: ${error.message}`, isAuthReady: true, loading: false });
                  }
                }
              });

              return () => unsubscribe();
            } catch (err) {
              console.error("Firebase initialization failed:", err);
              set({ error: `Firebase initialization failed: ${err.message}`, loading: false });
            }
          }, []);

          useEffect(() => {
            if (state.isAuthReady && state.db && state.userId) {
              const fetchProducts = () => {
                set({ loading: true });
                const productsCollectionRef = window.firebaseFirestore.collection(state.db, `artifacts/${__app_id}/users/${state.userId}/products`);
                const q = window.firebaseFirestore.query(productsCollectionRef);

                const unsubscribe = window.firebaseFirestore.onSnapshot(q, (snapshot) => {
                  const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  set({ products: productsData, loading: false });
                  console.log("Products fetched:", productsData);
                  if (productsData.length === 0) {
                    // Add some dummy data if no products exist
                    addDummyProducts(state.db, state.userId);
                  }
                }, (error) => {
                  console.error("Error fetching products:", error);
                  set({ error: `Failed to load products: ${error.message}`, loading: false });
                });
                return unsubscribe;
              };

              const fetchOrders = () => {
                const ordersCollectionRef = window.firebaseFirestore.collection(state.db, `artifacts/${__app_id}/users/${state.userId}/orders`);
                const q = window.firebaseFirestore.query(ordersCollectionRef);

                const unsubscribe = window.firebaseFirestore.onSnapshot(q, (snapshot) => {
                  const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  set({ orders: ordersData });
                  console.log("Orders fetched:", ordersData);
                }, (error) => {
                  console.error("Error fetching orders:", error);
                  set({ error: `Failed to load orders: ${error.message}` });
                });
                return unsubscribe;
              };

              const unsubscribeProducts = fetchProducts();
              const unsubscribeOrders = fetchOrders();

              return () => {
                unsubscribeProducts();
                unsubscribeOrders();
              };
            }
          }, [state.isAuthReady, state.db, state.userId]); // Re-run when auth is ready or db/userId changes

          // Function to add dummy products if collection is empty
          const addDummyProducts = async (db, userId) => {
            const productsCollectionRef = window.firebaseFirestore.collection(db, `artifacts/${__app_id}/users/${userId}/products`);
            const existingDocs = await window.firebaseFirestore.getDocs(productsCollectionRef);
            if (existingDocs.empty) {
              console.log("Adding dummy products...");
              const dummyProducts = [
                {
                  name: 'Laptop Pro X',
                  sku: 'LPX-001',
                  description: 'High-performance laptop for professionals.',
                  category: 'Electronics',
                  supplier: 'TechCorp',
                  currentStock: 50,
                  minStockLevel: 10,
                  unitPrice: 1200,
                  sellingPrice: 1500,
                  imageUrl: 'https://placehold.co/100x100/A855F7/ffffff?text=Laptop',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: userId
                },
                {
                  name: 'Wireless Mouse',
                  sku: 'WM-002',
                  description: 'Ergonomic wireless mouse with long battery life.',
                  category: 'Accessories',
                  supplier: 'AccessoryHub',
                  currentStock: 200,
                  minStockLevel: 50,
                  unitPrice: 20,
                  sellingPrice: 35,
                  imageUrl: 'https://placehold.co/100x100/3B82F6/ffffff?text=Mouse',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: userId
                },
                {
                  name: 'Mechanical Keyboard',
                  sku: 'MK-003',
                  description: 'RGB mechanical keyboard for gaming and typing.',
                  category: 'Accessories',
                  supplier: 'GamingGear',
                  currentStock: 75,
                  minStockLevel: 15,
                  unitPrice: 80,
                  sellingPrice: 120,
                  imageUrl: 'https://placehold.co/100x100/EC4899/ffffff?text=Keyboard',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: userId
                },
                {
                  name: 'USB-C Hub',
                  sku: 'UCH-004',
                  description: 'Multi-port USB-C adapter for modern laptops.',
                  category: 'Accessories',
                  supplier: 'Connectivity Solutions',
                  currentStock: 150,
                  minStockLevel: 30,
                  unitPrice: 40,
                  sellingPrice: 60,
                  imageUrl: 'https://placehold.co/100x100/10B981/ffffff?text=USB+Hub',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: userId
                },
                {
                  name: 'External SSD 1TB',
                  sku: 'SSD-005',
                  description: 'Portable solid-state drive for fast data transfer.',
                  category: 'Storage',
                  supplier: 'DataVault',
                  currentStock: 30,
                  minStockLevel: 5,
                  unitPrice: 90,
                  sellingPrice: 130,
                  imageUrl: 'https://placehold.co/100x100/F59E0B/ffffff?text=SSD',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: userId
                }
              ];

              for (const product of dummyProducts) {
                await window.firebaseFirestore.addDoc(productsCollectionRef, product);
              }
              console.log("Dummy products added successfully!");
            }
          };

          const showCustomAlert = (title, message, isError = false) => {
            set(prevState => ({
              ...prevState,
              modal: {
                isOpen: true,
                title,
                message,
                isError,
                onClose: () => set(prev => ({ ...prev, modal: { isOpen: false } }))
              }
            }));
          };

          const showCustomConfirm = (title, message, onConfirm) => {
            set(prevState => ({
              ...prevState,
              confirmModal: {
                isOpen: true,
                title,
                message,
                onConfirm: () => {
                  onConfirm();
                  set(prev => ({ ...prev, confirmModal: { isOpen: false } }));
                },
                onCancel: () => set(prev => ({ ...prev, confirmModal: { isOpen: false } }))
              }
            }));
          };

          if (!state.isAuthReady || state.loading) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-gray-100">
                <LoadingSpinner />
              </div>
            );
          }

          if (state.error) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-red-100">
                <Modal isOpen={true} onClose={() => set({ error: null })} title="Application Error" isError={true}>
                  <p>{state.error}</p>
                  <p className="mt-2 text-sm text-gray-600">Please check your Firebase configuration and network connection.</p>
                </Modal>
              </div>
            );
          }

          return (
            <FirebaseContext.Provider value={{ db: state.db, auth: state.auth, userId: state.userId, appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', selectedCurrency: state.selectedCurrency }}>
              <div className="min-h-screen bg-gray-100 flex flex-col md:flex-row">
                {/* Sidebar */}
                <aside className="w-full md:w-64 bg-gradient-to-br from-purple-700 to-indigo-800 text-white p-6 shadow-lg md:min-h-screen">
                  <div className="flex items-center mb-8">
                    <i className="fas fa-boxes text-3xl mr-3"></i>
                    <h2 className="text-3xl font-extrabold">Inventory</h2>
                  </div>
                  <nav>
                    <ul>
                      <li className="mb-4">
                        <button
                          onClick={() => setCurrentPage('dashboard')}
                          className={`flex items-center w-full p-3 rounded-lg text-lg font-medium transition-colors duration-200 ${
                            currentPage === 'dashboard' ? 'bg-purple-600 text-white shadow-md' : 'hover:bg-purple-600 hover:bg-opacity-70 text-purple-100'
                          }`}
                        >
                          <i className="fas fa-home text-xl mr-3"></i> Dashboard
                        </button>
                      </li>
                      <li className="mb-4">
                        <button
                          onClick={() => setCurrentPage('products')}
                          className={`flex items-center w-full p-3 rounded-lg text-lg font-medium transition-colors duration-200 ${
                            currentPage === 'products' ? 'bg-purple-600 text-white shadow-md' : 'hover:bg-purple-600 hover:bg-opacity-70 text-purple-100'
                          }`}
                        >
                          <i className="fas fa-box text-xl mr-3"></i> Products
                        </button>
                      </li>
                      <li className="mb-4">
                        <button
                          onClick={() => setCurrentPage('orders')}
                          className={`flex items-center w-full p-3 rounded-lg text-lg font-medium transition-colors duration-200 ${
                            currentPage === 'orders' ? 'bg-purple-600 text-white shadow-md' : 'hover:bg-purple-600 hover:bg-opacity-70 text-purple-100'
                          }`}
                        >
                          <i className="fas fa-shopping-cart text-xl mr-3"></i> Orders
                        </button>
                      </li>
                      <li className="mb-4">
                        <button
                          onClick={() => setCurrentPage('low-stock')}
                          className={`flex items-center w-full p-3 rounded-lg text-lg font-medium transition-colors duration-200 ${
                            currentPage === 'low-stock' ? 'bg-purple-600 text-white shadow-md' : 'hover:bg-purple-600 hover:bg-opacity-70 text-purple-100'
                          }`}
                        >
                          <i className="fas fa-exclamation-triangle text-xl mr-3"></i> Low Stock
                        </button>
                      </li>
                    </ul>
                  </nav>
                  <div className="mt-8 text-sm text-purple-200">
                    <p>User ID: <span className="font-mono break-all">{state.userId}</span></p>
                    <p className="mt-2">App ID: <span className="font-mono break-all">{typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}</span></p>
                    <p className="mt-4 text-xs">Developed by Sunny Jameel</p> {/* Added developer credit */}
                  </div>
                </aside>

                {/* Main Content Area */}
                <main className="flex-1 p-6 md:p-10 overflow-auto">
                  {/* Currency Selector in Main Content Header */}
                  <div className="flex justify-end mb-4 no-print">
                    <div className="flex items-center space-x-2">
                      <label htmlFor="appCurrencySelect" className="text-gray-700 text-sm">Currency:</label>
                      <select
                        id="appCurrencySelect"
                        value={state.selectedCurrency}
                        onChange={(e) => set({ selectedCurrency: e.target.value })}
                        className="p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-1 focus:ring-purple-500 text-sm"
                      >
                        {Object.keys(currencySymbols).map(currencyCode => (
                          <option key={currencyCode} value={currencyCode}>{currencyCode} ({currencySymbols[currencyCode]})</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  {currentPage === 'dashboard' && <Dashboard />}
                  {currentPage === 'products' && <ProductList />}
                  {currentPage === 'orders' && <OrderList />}
                  {currentPage === 'low-stock' && <LowStockAlerts />}
                </main>
              </div>

              {/* Global Modals */}
              {state.modal && state.modal.isOpen && (
                <Modal
                  isOpen={state.modal.isOpen}
                  onClose={state.modal.onClose}
                  title={state.modal.title}
                  isError={state.modal.isError}
                  footer={
                    <button
                      onClick={state.modal.onClose}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                    >
                      OK
                    </button>
                  }
                >
                  <p>{state.modal.message}</p>
                </Modal>
              )}

              {state.confirmModal && state.confirmModal.isOpen && (
                <Modal
                  isOpen={state.confirmModal.isOpen}
                  onClose={state.confirmModal.onCancel}
                  title={state.confirmModal.title}
                  footer={
                    <>
                      <button
                        onClick={state.confirmModal.onCancel}
                        className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={state.confirmModal.onConfirm}
                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                      >
                        Confirm
                      </button>
                    </>
                  }
                >
                  <p>{state.confirmModal.message}</p>
                </Modal>
              )}
            </FirebaseContext.Provider>
          );
        }

        // Dashboard Component
        const Dashboard = () => {
          const [state] = useStore();
          const { products, orders, selectedCurrency } = state;

          const totalProducts = products.length;
          const totalStockValue = products.reduce((sum, product) => sum + (product.currentStock * product.unitPrice), 0);
          const lowStockItems = products.filter(product => product.currentStock <= product.minStockLevel);
          const totalOrders = orders.length;

          // Calculate total sales from completed orders
          const totalSales = orders.reduce((sum, order) => {
            // Ensure order.orderDate is a Firestore Timestamp and convert it
            const orderDate = order.orderDate && typeof order.orderDate.toDate === 'function' ? order.orderDate.toDate() : new Date(order.orderDate);
            if (order.status === 'completed') {
              return sum + order.totalAmount;
            }
            return sum;
          }, 0);

          return (
            <div className="animate-fade-in">
              <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Dashboard Overview</h1>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <StatCard icon={<i className="fas fa-box-open text-2xl"></i>} title="Total Products" value={totalProducts} color="blue" />
                <StatCard icon={<i className="fas fa-dollar-sign text-2xl"></i>} title="Total Stock Value" value={`${currencySymbols[selectedCurrency]}${totalStockValue.toFixed(2)}`} color="green" />
                <StatCard icon={<i className="fas fa-exclamation-triangle text-2xl"></i>} title="Low Stock Items" value={lowStockItems.length} color="red" />
                <StatCard icon={<i className="fas fa-shopping-cart text-2xl"></i>} title="Total Sales (Completed)" value={`${currencySymbols[selectedCurrency]}${totalSales.toFixed(2)}`} color="purple" />
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Low Stock Alerts Section */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i className="fas fa-exclamation-triangle text-red-500 mr-2"></i> Low Stock Alerts
                  </h2>
                  {lowStockItems.length > 0 ? (
                    <ul className="space-y-3">
                      {lowStockItems.map(product => (
                        <li key={product.id} className="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                          <span className="font-medium text-red-800">{product.name} (SKU: {product.sku})</span>
                          <span className="text-red-600 font-semibold">Stock: {product.currentStock} / Min: {product.minStockLevel}</span>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div className="text-center text-gray-500 py-8">
                      <i className="fas fa-box text-5xl mx-auto mb-4 text-green-400"></i>
                      <p className="text-lg">No low stock items. All good!</p>
                    </div>
                  )}
                </div>

                {/* Recent Orders Section */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i className="fas fa-shopping-cart text-indigo-500 mr-2"></i> Recent Orders
                  </h2>
                  {orders.length > 0 ? (
                    <div className="overflow-x-auto">
                      <table className="min-w-full bg-white">
                        <thead>
                          <tr className="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Order ID</th>
                            <th className="py-3 px-6 text-left">Customer</th>
                            <th className="py-3 px-6 text-right">Amount</th>
                            <th className="py-3 px-6 text-center">Status</th>
                          </tr>
                        </thead>
                        <tbody className="text-gray-700 text-sm font-light">
                          {orders.slice(0, 5).map(order => ( // Show last 5 orders
                            <tr key={order.id} className="border-b border-gray-200 hover:bg-gray-50">
                              <td className="py-3 px-6 text-left whitespace-nowrap">{order.orderId}</td>
                              <td className="py-3 px-6 text-left">{order.customerName}</td>
                              <td className="py-3 px-6 text-right">{currencySymbols[selectedCurrency]}{order.totalAmount.toFixed(2)}</td>
                              <td className="py-3 px-6 text-center">
                                <span className={`py-1 px-3 rounded-full text-xs font-semibold ${
                                  order.status === 'completed' ? 'bg-green-200 text-green-800' :
                                  order.status === 'pending' ? 'bg-yellow-200 text-yellow-800' :
                                  'bg-red-200 text-red-800'
                                }`}>
                                  {order.status}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ) : (
                    <div className="text-center text-gray-500 py-8">
                      <i className="fas fa-shopping-cart text-5xl mx-auto mb-4 text-gray-400"></i>
                      <p className="text-lg">No orders yet.</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // StatCard Component for Dashboard
        const StatCard = ({ icon, title, value, color }) => {
          const colorClasses = {
            blue: 'bg-blue-100 text-blue-600',
            green: 'bg-green-100 text-green-600',
            red: 'bg-red-100 text-red-600',
            purple: 'bg-purple-100 text-purple-600',
          };
          return (
            <div className="bg-white rounded-xl shadow-lg p-6 flex items-center justify-between hover:shadow-xl transition-shadow duration-200">
              <div>
                <p className="text-gray-600 text-sm">{title}</p>
                <p className="text-3xl font-bold text-gray-800 mt-1">{value}</p>
              </div>
              <div className={`p-3 rounded-full ${colorClasses[color]}`}>
                {icon}
              </div>
            </div>
          );
        };

        // ProductList Component
        const ProductList = () => {
          const [state, set] = useStore();
          const { products, db, userId, loading, selectedCurrency } = state;
          const { appId } = useContext(FirebaseContext);

          const [isProductModalOpen, setIsProductModalOpen] = useState(false);
          const [currentProduct, setCurrentProduct] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [filterCategory, setFilterCategory] = useState('All');
          const [sortKey, setSortKey] = useState('name');
          const [sortDirection, setSortDirection] = useState('asc'); // 'asc' or 'desc'

          const categories = [...new Set(products.map(p => p.category))];

          const filteredProducts = products.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                  product.sku.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                  product.description.toLowerCase().includes(searchQuery.toLowerCase());
            const matchesCategory = filterCategory === 'All' || product.category === filterCategory;
            return matchesSearch && matchesCategory;
          });

          const sortedProducts = [...filteredProducts].sort((a, b) => {
            if (a[sortKey] < b[sortKey]) return sortDirection === 'asc' ? -1 : 1;
            if (a[sortKey] > b[sortKey]) return sortDirection === 'asc' ? 1 : -1;
            return 0;
          });

          const handleSort = (key) => {
            if (sortKey === key) {
              setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
            } else {
              setSortKey(key);
              setSortDirection('asc');
            }
          };

          const openAddProductModal = () => {
            setCurrentProduct(null);
            setIsProductModalOpen(true);
          };

          const openEditProductModal = (product) => {
            setCurrentProduct(product);
            setIsProductModalOpen(true);
          };

          const deleteProduct = async (id) => {
            if (!db || !userId) {
              showCustomAlert('Error', 'Database not ready or user not authenticated.', true);
              return;
            }
            showCustomConfirm('Confirm Delete', 'Are you sure you want to delete this product?', async () => {
              try {
                await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(db, `artifacts/${appId}/users/${userId}/products`, id));
                showCustomAlert('Success', 'Product deleted successfully!');
              } catch (e) {
                console.error("Error deleting product: ", e);
                showCustomAlert('Error', `Failed to delete product: ${e.message}`, true);
              }
            });
          };

          // Custom Alert/Confirm functions for within components
          const showCustomAlert = (title, message, isError = false) => {
            set(prevState => ({
              ...prevState,
              modal: {
                isOpen: true,
                title,
                message,
                isError,
                onClose: () => set(prev => ({ ...prev, modal: { isOpen: false } }))
              }
            }));
          };

          const showCustomConfirm = (title, message, onConfirm) => {
            set(prevState => ({
              ...prevState,
              confirmModal: {
                isOpen: true,
                title,
                message,
                onConfirm: () => {
                  onConfirm();
                  set(prev => ({ ...prev, confirmModal: { isOpen: false } }));
                },
                onCancel: () => set(prev => ({ ...prev, confirmModal: { isOpen: false } }))
              }
            }));
          };

          return (
            <div className="animate-fade-in">
              <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Product Management</h1>

              <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                  <div className="relative w-full md:w-1/3">
                    <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
                    <input
                      type="text"
                      placeholder="Search products by name or SKU..."
                      className="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                  </div>
                  <div className="relative w-full md:w-1/4">
                    <i className="fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
                    <select
                      className="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent appearance-none bg-white"
                      value={filterCategory}
                      onChange={(e) => setFilterCategory(e.target.value)}
                    >
                      <option value="All">All Categories</option>
                      {categories.map(category => (
                        <option key={category} value={category}>{category}</option>
                      ))}
                    </select>
                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                      <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                  </div>
                  <button
                    onClick={openAddProductModal}
                    className="w-full md:w-auto bg-purple-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-purple-700 transition-colors flex items-center justify-center font-semibold"
                  >
                    <i className="fas fa-plus-circle text-lg mr-2"></i> Add New Product
                  </button>
                </div>

                {loading ? (
                  <LoadingSpinner />
                ) : sortedProducts.length === 0 ? (
                  <div className="text-center text-gray-500 py-12">
                    <i className="fas fa-box text-5xl mx-auto mb-4 text-gray-400"></i>
                    <p className="text-xl font-medium">No products found.</p>
                    <p className="text-md">Try adjusting your search or filters, or add a new product!</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto rounded-lg border border-gray-200">
                    <table className="min-w-full bg-white divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => handleSort('name')}>
                            Product Name {sortKey === 'name' && (sortDirection === 'asc' ? '▲' : '▼')}
                          </th>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => handleSort('sku')}>
                            SKU {sortKey === 'sku' && (sortDirection === 'asc' ? '▲' : '▼')}
                          </th>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => handleSort('category')}>
                            Category {sortKey === 'category' && (sortDirection === 'asc' ? '▲' : '▼')}
                          </th>
                          <th className="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => handleSort('currentStock')}>
                            Stock {sortKey === 'currentStock' && (sortDirection === 'asc' ? '▲' : '▼')}
                          </th>
                          <th className="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => handleSort('sellingPrice')}>
                            Price {sortKey === 'sellingPrice' && (sortDirection === 'asc' ? '▲' : '▼')}
                          </th>
                          <th className="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {sortedProducts.map(product => (
                          <tr key={product.id} className="hover:bg-gray-50 transition-colors">
                            <td className="py-4 px-6 whitespace-nowrap">
                              <div className="flex items-center">
                                <img className="h-10 w-10 rounded-full object-cover mr-3" src={product.imageUrl || 'https://placehold.co/40x40/cccccc/ffffff?text=P'} alt={product.name} onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/40x40/cccccc/ffffff?text=P'; }} />
                                <div className="text-sm font-medium text-gray-900">{product.name}</div>
                              </div>
                            </td>
                            <td className="py-4 px-6 whitespace-nowrap text-sm text-gray-500">{product.sku}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-sm text-gray-500">{product.category}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-right text-sm font-medium">
                              <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                product.currentStock <= product.minStockLevel ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                              }`}>
                                {product.currentStock}
                              </span>
                            </td>
                            <td className="py-4 px-6 whitespace-nowrap text-right text-sm text-gray-500">{currencySymbols[selectedCurrency]}{product.sellingPrice.toFixed(2)}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-center text-sm font-medium">
                              <div className="flex items-center justify-center space-x-3">
                                <button onClick={() => openEditProductModal(product)} className="text-indigo-600 hover:text-indigo-900" title="Edit">
                                  <i className="fas fa-edit text-lg"></i>
                                </button>
                                <button onClick={() => deleteProduct(product.id)} className="text-red-600 hover:text-red-900" title="Delete">
                                  <i className="fas fa-trash-alt text-lg"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <ProductForm
                isOpen={isProductModalOpen}
                onClose={() => setIsProductModalOpen(false)}
                product={currentProduct}
                showCustomAlert={showCustomAlert}
              />
            </div>
          );
        };

        // ProductForm Component
        const ProductForm = ({ isOpen, onClose, product, showCustomAlert }) => {
          const { db, userId, appId, selectedCurrency } = useContext(FirebaseContext);
          const [formData, setFormData] = useState({
            name: '',
            sku: '',
            description: '',
            category: '',
            supplier: '',
            currentStock: 0,
            minStockLevel: 0,
            unitPrice: 0,
            sellingPrice: 0,
            imageUrl: '',
          });
          const [formLoading, setFormLoading] = useState(false);

          useEffect(() => {
            if (product) {
              setFormData({
                name: product.name || '',
                sku: product.sku || '',
                description: product.description || '',
                category: product.category || '',
                supplier: product.supplier || '',
                currentStock: product.currentStock || 0,
                minStockLevel: product.minStockLevel || 0,
                unitPrice: product.unitPrice || 0,
                sellingPrice: product.sellingPrice || 0,
                imageUrl: product.imageUrl || '',
              });
            } else {
              // Reset form for new product
              setFormData({
                name: '',
                sku: '',
                description: '',
                category: '',
                supplier: '',
                currentStock: 0,
                minStockLevel: 0,
                unitPrice: 0,
                sellingPrice: 0,
                imageUrl: '',
              });
            }
          }, [product, isOpen]);

          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormData(prev => ({
              ...prev,
              [name]: type === 'number' ? parseFloat(value) || 0 : value
            }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !userId) {
              showCustomAlert('Error', 'Database not ready or user not authenticated.', true);
              return;
            }

            // Basic validation
            if (!formData.name || !formData.sku || !formData.category || formData.currentStock < 0 || formData.sellingPrice <= 0) {
              showCustomAlert('Validation Error', 'Please fill in all required fields (Name, SKU, Category, Stock, Selling Price) correctly.', true);
              return;
            }

            setFormLoading(true);
            try {
              const productData = {
                ...formData,
                updatedAt: new Date(),
                userId: userId // Ensure userId is always set
              };

              if (product) {
                // Update existing product
                await window.firebaseFirestore.updateDoc(window.firebaseFirestore.doc(db, `artifacts/${appId}/users/${userId}/products`, product.id), productData);
                showCustomAlert('Success', 'Product updated successfully!');
              } else {
                // Add new product
                productData.createdAt = new Date();
                await window.firebaseFirestore.addDoc(window.firebaseFirestore.collection(db, `artifacts/${appId}/users/${userId}/products`), productData);
                showCustomAlert('Success', 'Product added successfully!');
              }
              onClose();
            } catch (e) {
              console.error("Error saving product: ", e);
              showCustomAlert('Error', `Failed to save product: ${e.message}`, true);
            } finally {
              setFormLoading(false);
            }
          };

          return (
            <Modal isOpen={isOpen} onClose={onClose} title={product ? 'Edit Product' : 'Add New Product'}>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label htmlFor="name" className="block text-sm font-medium text-gray-700">Product Name <span className="text-red-500">*</span></label>
                  <input type="text" id="name" name="name" value={formData.name} onChange={handleChange} required
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                </div>
                <div>
                  <label htmlFor="sku" className="block text-sm font-medium text-gray-700">SKU <span className="text-red-500">*</span></label>
                  <input type="text" id="sku" name="sku" value={formData.sku} onChange={handleChange} required
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                </div>
                <div>
                  <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
                  <textarea id="description" name="description" value={formData.description} onChange={handleChange} rows="3"
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div>
                  <label htmlFor="category" className="block text-sm font-medium text-gray-700">Category <span className="text-red-500">*</span></label>
                  <input type="text" id="category" name="category" value={formData.category} onChange={handleChange} required
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                </div>
                <div>
                  <label htmlFor="supplier" className="block text-sm font-medium text-gray-700">Supplier</label>
                  <input type="text" id="supplier" name="supplier" value={formData.supplier} onChange={handleChange}
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="currentStock" className="block text-sm font-medium text-gray-700">Current Stock <span className="text-red-500">*</span></label>
                    <input type="number" id="currentStock" name="currentStock" value={formData.currentStock} onChange={handleChange} required min="0"
                      className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                  </div>
                  <div>
                    <label htmlFor="minStockLevel" className="block text-sm font-medium text-gray-700">Min Stock Level</label>
                    <input type="number" id="minStockLevel" name="minStockLevel" value={formData.minStockLevel} onChange={handleChange} min="0"
                      className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="unitPrice" className="block text-sm font-medium text-gray-700">Unit Price (Cost) ({currencySymbols[selectedCurrency]})</label>
                    <input type="number" id="unitPrice" name="unitPrice" value={formData.unitPrice} onChange={handleChange} step="0.01" min="0"
                      className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                  </div>
                  <div>
                    <label htmlFor="sellingPrice" className="block text-sm font-medium text-gray-700">Selling Price ({currencySymbols[selectedCurrency]}) <span className="text-red-500">*</span></label>
                    <input type="number" id="sellingPrice" name="sellingPrice" value={formData.sellingPrice} onChange={handleChange} step="0.01" min="0" required
                      className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                  </div>
                </div>
                <div>
                  <label htmlFor="imageUrl" className="block text-sm font-medium text-gray-700">Image URL</label>
                  <input type="text" id="imageUrl" name="imageUrl" value={formData.imageUrl} onChange={handleChange}
                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" />
                  {formData.imageUrl && (
                    <img src={formData.imageUrl} alt="Product Preview" className="mt-2 h-20 w-20 object-cover rounded-md" onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/80x80/cccccc/ffffff?text=No+Image'; }} />
                  )}
                </div>
                <div className="flex justify-end space-x-3 mt-6">
                  <button type="button" onClick={onClose} className="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                  </button>
                  <button type="submit" disabled={formLoading} className="px-5 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                    {formLoading && <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>}
                    {product ? 'Update Product' : 'Add Product'}
                  </button>
                </div>
              </form>
            </Modal>
          );
        };

        // OrderList Component (Placeholder for now)
        const OrderList = () => {
          const [state] = useStore();
          const { orders, loading, selectedCurrency } = state;

          return (
            <div className="animate-fade-in">
              <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Order Management</h1>
              <div className="bg-white rounded-xl shadow-lg p-6">
                {loading ? (
                  <LoadingSpinner />
                ) : orders.length === 0 ? (
                  <div className="text-center text-gray-500 py-12">
                    <i className="fas fa-shopping-cart text-5xl mx-auto mb-4 text-gray-400"></i>
                    <p className="text-xl font-medium">No orders yet.</p>
                    <p className="text-md">Create your first order to see it here!</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto rounded-lg border border-gray-200">
                    <table className="min-w-full bg-white divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                          <th className="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                          <th className="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                          <th className="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {orders.map(order => (
                          <tr key={order.id} className="hover:bg-gray-50 transition-colors">
                            <td className="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-900">{order.orderId}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-sm text-gray-500">{order.customerName}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-sm text-gray-500">{order.orderDate && typeof order.orderDate.toDate === 'function' ? new Date(order.orderDate.toDate()).toLocaleDateString() : 'N/A'}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-right text-sm text-gray-500">{currencySymbols[selectedCurrency]}{order.totalAmount.toFixed(2)}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-center">
                              <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                order.status === 'completed' ? 'bg-green-100 text-green-800' :
                                order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {order.status}
                              </span>
                            </td>
                            <td className="py-4 px-6 whitespace-nowrap text-center text-sm font-medium">
                              <div className="flex items-center justify-center space-x-3">
                                {/* Add View/Edit/Delete Order buttons here */}
                                <button className="text-indigo-600 hover:text-indigo-900" title="View Order">
                                  <i className="fas fa-eye text-lg"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // LowStockAlerts Component (Placeholder for now)
        const LowStockAlerts = () => {
          const [state] = useStore();
          const { products, loading } = state;
          const lowStockItems = products.filter(product => product.currentStock <= product.minStockLevel);

          return (
            <div className="animate-fade-in">
              <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Low Stock Alerts</h1>
              <div className="bg-white rounded-xl shadow-lg p-6">
                {loading ? (
                  <LoadingSpinner />
                ) : lowStockItems.length === 0 ? (
                  <div className="text-center text-gray-500 py-12">
                    <i className="fas fa-box text-5xl mx-auto mb-4 text-green-400"></i>
                    <p className="text-xl font-medium">No low stock items. Everything is well-stocked!</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto rounded-lg border border-gray-200">
                    <table className="min-w-full bg-white divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                          <th className="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                          <th className="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                          <th className="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Min Stock Level</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {lowStockItems.map(product => (
                          <tr key={product.id} className="bg-red-50 hover:bg-red-100 transition-colors">
                            <td className="py-4 px-6 whitespace-nowrap text-sm font-medium text-red-800">{product.name}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-sm text-red-700">{product.sku}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-right text-sm font-bold text-red-600">{product.currentStock}</td>
                            <td className="py-4 px-6 whitespace-nowrap text-right text-sm text-red-500">{product.minStockLevel}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Render the App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
